pipeline {
agent any
environment {
    registry = "ritul3007/devops_practice"
    registryCredential = 'docker-hub'
    dockerImage = ''
  }
stages {
    stage('SCM Checkout') {
        steps {
            git 'https://github.com/ritul3007/devopsPractice.git'
        }
    }

    stage('Maven Build') {
        steps {
             echo "PATH = ${PATH}"
             echo "M2_HOME = ${M2_HOME}"
             sh 'mvn clean install' 
        }
    }
    
    stage('Build Image') {
        steps{
            script {
                dockerImage = docker.build registry + ":$BUILD_NUMBER"
            }
        }
    }
	
	stage('Test Image') {
	    steps {
            script {
	            dockerImage.inside {
				echo "test passed"
				}
            }
        }
	}
	
    stage('PUSH image to Docker Hub') {
	    steps {
	        script{
		        docker.withRegistry('', registryCredential) {
		        dockerImage.push("${env.BUILD_NUMBER}")
		        }
	        }
		
		echo "Trying to Push Docker Image"
        }
    }
	
	stage('Remove Unused docker image') {
        steps{
            sh "docker rmi $registry:$BUILD_NUMBER"
        }
    }
  } 	 	
}
